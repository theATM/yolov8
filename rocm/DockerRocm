FROM rocm/pytorch:rocm5.5_ubuntu20.04_py3.8_pytorch_1.12.1

# without cp-custer

# Install pytorch (15.7.23)

COPY pytorch /pytorch_arch

RUN python3 -m pip uninstall torch torchvision torchaudio -y

RUN python3 -m pip install /pytorch_arch/torch-2.1.0.dev20230716+rocm5.5-cp38-cp38-linux_x86_64.whl
RUN python3 -m pip install /pytorch_arch/torchvision-0.16.0.dev20230716+rocm5.5-cp38-cp38-linux_x86_64.whl
RUN python3 -m pip install /pytorch_arch/torchaudio-2.1.0.dev20230716+rocm5.5-cp38-cp38-linux_x86_64.whl


WORKDIR /project

COPY rocm_requirements.txt /project/rocm_requirements.txt

RUN python -m pip install -r /project/rocm_requirements.txt


# Install mmcv - without cp-clustering
# First get mmcv from github
# copy the mmcv to rocm folder
# change setup.py (change all c++14 to c++17)
# And then those will not fail:
COPY mmcv /project/mmcv
#RUN MMCV_WITH_OPS=1 pip install -e /project/mmcv
WORKDIR /project/mmcv
#RUN MMCV_WITH_OPS=1 cxx=-std=c++17 ROCM_HOME=/opt/rocm python3 setup.py install
RUN MMCV_WITH_OPS=1 ROCM_HOME=/opt/rocm python3 setup.py install
WORKDIR /project
